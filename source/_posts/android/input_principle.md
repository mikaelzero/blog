---
title: IMS
date: 2023/03/08
tags:
  - android
  - framework
  - input
  - IMS
---

Android 系统层面的输入法窗口原理是在应用程序的窗口上方弹出一个悬浮窗口，该窗口可以响应用户的输入并将输入内容传递给应用程序。下面是输入法窗口的实现原理：

当用户在应用程序中需要输入文本时，Android 系统会自动弹出输入法窗口，该窗口位于应用程序的窗口之上。
输入法窗口会接收用户输入的文本，并将其传递给应用程序。为了实现这一点，输入法窗口使用了一个称为 InputConnection 的接口，该接口将输入的文本传递给应用程序。

在输入法窗口中，用户可以选择不同的输入法类型，例如 QWERTY 键盘、手写输入或语音输入等。输入法窗口会根据用户的选择来展示不同的输入界面。
Android 系统还提供了一个 InputMethodManager 类来管理输入法窗口的显示和隐藏。通过该类，应用程序可以请求显示或隐藏输入法窗口，以便更好地管理用户的输入体验。
总的来说，Android 系统层面的输入法窗口原理是在应用程序窗口上方弹出一个悬浮窗口，该窗口可以接收用户输入的文本，并将其传递给应用程序。同时，Android 系统还提供了一些类和接口来管理输入法窗口的显示和隐藏，以便更好地管理用户的输入体验。

InputMethodService 是一种特殊的服务，用于支持键盘输入。当用户需要输入时，系统会自动启动 InputMethodService 并显示它的窗口。您可以通过 InputMethodManager 类中的一些方法来管理和控制 InputMethodService 的行为，例如 showSoftInput()、hideSoftInput()、switchToNextInputMethod() 等。但是，这些方法都不能直接获取 InputMethodService 对象。

### 如何自动启动 IMS

当用户在应用程序中点击一个文本输入框时，应用程序会调用 InputMethodManager 的 showSoftInput() 方法，并传递当前输入框的信息。该方法将触发系统启动输入法服务，并将当前输入框的信息传递给输入法服务。

输入法服务会在启动时调用 onCreate() 方法，并在该方法中进行初始化操作，例如加载布局文件、注册广播接收器等。然后，系统会调用 onStartInput() 方法，以向输入法服务提供当前输入框的信息，例如输入框的位置和大小等。在 onStartInput() 方法中，您可以根据这些信息来调整键盘的位置和大小，以确保它能够完全覆盖输入框。

在启动输入法服务后，输入法服务会创建一个包含键盘的窗口，并将该窗口添加到系统窗口管理器中。然后，系统会将该窗口显示在当前应用程序的上层，允许用户输入文本。用户可以通过键盘输入文本，并且输入的文本将被发送到应用程序中的当前输入框中。

当用户完成输入后，系统会调用输入法服务的 onFinishInput() 方法，并将输入的文本传递给该方法。在 onFinishInput() 方法中，您可以对输入的文本进行处理，并将其发送到应用程序中的当前输入框中。然后，系统会将键盘窗口从系统窗口管理器中移除，输入法服务会被销毁。
